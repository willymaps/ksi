<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>test</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link href="../css/textstyle.css" rel="stylesheet" type="text/css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<div id="columnWrap">

  <div id="columnHold">
  </div>
  <div id="columnText">
    <p id="textHed"></p>
    <p id="textDesc"></p>
    <div id="barHold">
    </div>
  </div>
  <div id="popup">
      <p>Date: <span id="popupDate"></span></p>
      <p>Streets: <span id="popupInter"></span></p>
      <p>Time: <span id="popupTime"></span></p>
      <p>Road Class: <span id="popupRoad"></span></p>
  </div>
  <div id="backBtn">
    <
  </div>
  <div id="streetviewHold">
    <img id="streetviewImg" src="../img/streetview.png" alt="Streetview images of the locations where the incididents happened.">
    <img id="mapviewImg" src="../img/map.png" alt="Deaths by Toronto ward.">
  </div>
  <div id="wardHold">
  </div>
</div>

</body>


<script src='../js/getstages.js'></script>
<script>

var barChartArray = [];

const timeColors = [
'#3E2230',
'#4F2B3A',
'#603343',
'#733C4C',
'#864553',
'#994E5B',
'#AD5861',
'#C06266',
'#D46D6B',
'#E7796F',
'#FA8572'
];

$.getJSON( "./data/padfat.json", function( data ) {
  // console.log('data', data);
  
  const years = [];
  const allData = [];
  $.each(data, function( key, val ) {
  	if ($.inArray(val.YEAR, years) === -1) {
        years.push(val.YEAR);
        // console.log('years', years);
        // var val.YEAR + 'yr' = ([]);
    }
    allData.push(data[key]);
  });

  // console.log('allData', allData);

  years.sort(function(a, b){return a-b});
  allData.sort(function(a, b){return a.YEAR-b.YEAR});
  // console.log('allData sorted', allData);

  const yearsArray = years.map(function(item, key) {
    // console.log('item', Array.of(years[key]));
    return Array.of(years[key]);
  });

  let counter = 0;
  for (i=0;i<allData.length;i++) {
    if (allData[i].YEAR == years[counter]) {
      yearsArray[counter].push(
        textToPush(allData[i])
        );
    } else {
      counter++;
      yearsArray[counter].push(
        textToPush(allData[i])
        );
    }
  }

  function textToPush(data) {
    return "<li id='" +
      data.ID +
      "' data-time='" +
      data.TIME +
      "' data-vis='" +
      data.VISIBILITY +
      "' data-streetone='" +
      data.STREET1 +
      "' data-streettwo='" +
      data.STREET2 +
      "' data-roadclass='" +
      data.ROAD_CLASS +
      "' data-date='" +
      data.DATE +
      "' data-light='" +
      data.LIGHT +
      "' data-age='" +
      data.INVAGE +
      "' style='color:" +
      timeColors[counter] +
      "'>" +
      'FATAL' +
      // allData[i].INVAGE +
      // " + " +
      // allData[i].STREET2 +
    "</li>"
  }

  // console.log('yearsArray', yearsArray);

  let colCount = 0;
  for (i=0;i<yearsArray.length;i++) {

      let columnName = 'column' + i;
      let columnNameCol = '#column' + i;

    // } else if ( i && (i % 3 === 0)) {
      $('<div />', {
      "class": 'column',
      "id": columnName
      }).appendTo("#columnHold");
    // }
    
    $( "<ul/>", {
      "id": yearsArray[i],
      html: yearsArray[i].join("")
    }).css('color', timeColors[i]).appendTo( columnNameCol);
    // console.log('tagname', this.tagName);
  }

  var timer;

    $("li").hover(function(){
        // console.log('data', data);
        // console.log($(this).data("date"));
        clearTimeout(timer)
        $(this).css("border", "1px solid #333");
        $(this).css("cursor", "pointer");
        $('#popup').css("bottom", "0px");

        // console.log('streets', $(this).data("streettwo").length);

        let streetnames;

        if ($(this).data("streettwo").length > 2) {
          streetnames = $(this).data("streetone") + ' + ' + $(this).data("streettwo");
        } else {
          streetnames = $(this).data("streetone");
        }

        $('#popupDate').text($(this).data("date").slice(0, 10));
        $('#popupInter').text(streetnames);
        $('#popupTime').text($(this).data("time"));
        $('#popupRoad').text($(this).data("roadclass"));

      }, function() {
        // console.log($(this).data("LIGHT"));
        $(this).css("border", "1px solid transparent");
        $(this).css("cursor", "inherit");
        timer = setTimeout( function(){
          $('#popup').css("bottom", "-160px");  
        }, 1000);
          // $('#popup').css("bottom", "-120px");
    });
}).done(function() {
  initStage();
  console.log('done');
}).fail(function() {
  console.log( "error" );
});

$.getJSON( "./data/council.json", function( data ) {
  console.log('data', data);

  var councilData = [];
  $.each(data, function( key, val ) {
    councilData.push(data[key]);
  });

  var table = document.createElement('table');
  // console.log('table length', councilData.length);
  // console.log('table length', councilData[i]);
    for (var i = 0; i < councilData.length; i++){
      // console.log('table pieces', councilData[i]);

    $('<div />', {
      "class": 'wards',
      // "id": columnName,
      "html": getCouncilInfo(councilData[i])
    }).appendTo("#wardHold");

    }

  function getCouncilInfo(data) {
    console.log('data', data);
    return  "<b>" + data.count + " killed" + "</b> â€“ <span class='councillorName'><a href='mailto:" + data.email + "'>" + "in Ward " + data.ward + " " + data.firstname + " " + data.lastname + " (" + data.email + ')</a></span>'
  }

}).done(function() {
  console.log('done');

}).fail(function() {
  console.log('error')
});

var stage = 1;
var time = 50;

$('#backBtn').click(function(e) {
  console.log('clicked');
  console.log('stage back', stage);
  
  if (stage >= 3) {
    stage = stage - 1;
    console.log('stage back', stage);
  } else if (stage == 2) {
    $(this).css('opacity', 0.2);
    stage = stage - 1;
  }

  getStage();

  e.stopPropagation();
});


$('#columnWrap').click(function(e) {
  console.log('clicked'); 
  stage++;
  $('#backBtn').css('opacity', 1);

  getStage();
  // e.stopPropagation();
  
});


function initStage() {
    $('#textHed').text(
      'What 11 Years of Pedestrian and Cyclist Deaths in Toronto can tell us'
    );
    $('#textDesc').text(
        'The Toronto Police Service has recently updated their traffic related fatality numbers, which include all incidents and their attribute information between 2007 and 2017...'
    );

    $('li').each(function() {
      let liElem = this;
      let liParent = $(liElem).parent();
      $(liParent).css('opacity', 1);

      setTimeout( function(){ $(liElem).css('opacity', 1); }, time)
        time += 20;
    });
}

</script>

</html>
